$('#add-trip').click(function(){
    //Getting the index for the div
    // const index = $('#cruise_trips div.form-group').length;
    const index = +$('#widgets-counter-trips').val(); //unary '+' to convert string to number

    const indexObj = counterTrips.countTrip;


    //Getting the prototype (code used to generate the html template)...and adding the index...e.g. position outside the present length
    const tmpl = $('#cruise_trips').data('prototype').replace(/__name__/g, index);
    //Injection of the new code
    var elementTrip = $(tmpl);
    // console.log(element);
    $('#cruise_trips').append(elementTrip);

    //Add 1 to the index (for counter)
    $('#widgets-counter-trips').val(index+1);
    counterTrips.countTrip = indexObj + 1;
    console.log(counterTrips);

    // //get the id of the block, generated by twig...eg. "cruise_trips_0", "cruise_trips_1",.....
    // const idBlockTrip = $(elementTrip[0]['firstElementChild']).attr('id').replace('block_', '');

    //bind the event handler to the 'remove-trip' button that has been created
    deleteTrip(elementTrip);
    cloneTrip(elementTrip);

    //check the events linked ot the button
    // console.log($._data($('[data-action="delete"]')[0], 'events'));

    AddTripInvestigatorsHandler(elementTrip);


})

function cloneTrip(contextElement){
    $('button.clone-trip[data-action="clone"]', contextElement).click(function(){
        // const target = e.dataset.target;
        console.log('clone trip');
        // console.log(this.dataset.target);
        // console.log($(this.dataset.target).parent('fieldset').parent('div'));
        //fetching the prototype for the trips
        const index = +$('#widgets-counter-trips').val();
        // const sectionTripToClone = $(this.dataset.target).parent('fieldset');
        // console.log(sectionTripToClone);
        const target = this.dataset.target;
        //Select every input inside the target...loop through them ....copy the value of the input, and set it as value into the innerHTML  (attr() is the HTML attribute)

        $("input", target).each(function (idx, inputElement) {
             var ie = $(inputElement);
             ie.attr("value", ie.val())
        })
        const clonedTrip = $(target).parent('fieldset').clone();
        // console.log(clonedTrip);


        //  NB Somehow unable to modify properties of the object clonedTrip (declared as "let clonedTrip").
        //  Therefore, just extracting the innerHTML code, modify it (also removing the <a> tag linking to trip_edit (as the trip as not been submitted yet),
        //  and appending it to the form

        //update the attributes id (e.g. cruise_trips_0_tripinvestigators_0_surname to cruise_trips_3_tripinvestigators_0_surname)
        let clonedTripHTML = clonedTrip['0'].innerHTML.replace(/_trips_\d+/g, '_trips_' + index);


        //update the attributes name (e.g. name="cruise[trips][0][tripinvestigators][0][surname]" to name="cruise[trips][3][tripinvestigators][0][surname]"
        clonedTripHTML = clonedTripHTML.replace(/\[trips\]\[\d+\]/g, '[trips][' + index + ']');

        clonedTripHTML = "<fieldset class='form-group'>" + clonedTripHTML + "</fieldset>";

        //REMOVE THE CLONE BUTTON (for simplification no event handler for that functionality)...
        // clonedTripHTML = clonedTripHTML.replace(/<button type="button" class="btn btn-primary clone-trip" data-action="clone" data-id="cruise_trips_\d+" data-target="#block_cruise_trips_\d+"><i class="fa fa-clone fa-2x"><\/i><\/button>/,'');

        // clonedTripHTML = clonedTripHTML.replace(/<button type="button" class="btn btn-primary clone-trip" data-action="clone" data-id="cruise_trips_\d+" data-target="#block_cruise_trips_\d+">[\s\n]*<i class="fa fa-clone fa-2x"><\/i>[\s\n]*<\/button>/,'');


        console.log(clonedTripHTML);

        const clonedTripElement = $(clonedTripHTML);

        $('div#cruise_trips').append(clonedTripElement);

        $('#widgets-counter-trips').val(index+1);


        /// !!!!! context ELEMENT?????
        AddTripInvestigatorsHandler(clonedTripElement)
        deleteTripinvestigators(clonedTripElement);
        cloneTrip(clonedTripElement);





        // const sectionTrip = $(this.dataset.target).parent('fieldset').parent('div');
        // const tmplTrip = $(sectionTrip).data('prototype').replace(/__name__/g, index);
        // console.log(tmplTrip);
        // var elementTrip = $(tmplTrip);

    })
}

function deleteTrip(contextElement){
    // 'button#remove-trip[data-action="delete"]'  'button[data-id="'+idBlock+'"][data-action="delete"]'
    $('button.remove-trip[data-action="delete"]', contextElement).click(function(){
        // as we have created in Twig a 'data-target' attribute with the id selector of the block

        // console.log('delete-trip');
        // console.log(this.dataset.target);
        const target=this.dataset.target;
        $(target).parent('fieldset').remove();


    })
}



function updateCounterTrips(){
    //counting the number of trip sections (here by counting the input for start date)
    const count = $('input[id$=startdate]').length;
    $('#widgets-counter-trips').val(count);
    // console.log('countTrip ' + count);
    // let tripInvestigatorsCount = {};

    window.counterTrips.countTrip = count;
    console.log(counterTrips);


    //LOOPING (counting the number for the counter as the first part of the selector for trip and tripinvestigator is the same
    $('input[id^=widgets-counter-tripinvestigators-][type="hidden"]').each(function(){
        let idCounter = this['id'];
        idCounter = idCounter.replace('widgets-counter-tripinvestigators-', '');
        idCounter= idCounter.replace('_tripinvestigators','');

        //idCounter is a string such as cruise_trips_0, cruise_trips_1,...
        const countTripInvestigators = $('input[id^='+idCounter+'][placeholder="First Name"]').length;

        //Rest the value of the tripinvestigators count for the trip
        $('input[id^=widgets-counter-tripinvestigators-'+ idCounter+ '_tripinvestigators]').val(countTripInvestigators);
    })
}



function  AddTripInvestigatorsHandler(contextElement){
    //Put the event as argument, as it allow us to get info on the target button
    $( '.add-tripinvestigator',contextElement).click(function(e){
    // $( '[id^=add-tripinvestigator]',contextElement).click(function(e){

        console.log('add tripinvestigator');
        console.log(contextElement);
        // console.log(e.target.parentElement);
        console.log(e.target.parentElement.parentElement);

        //e.target.parentElement.parentElement is actually the block of html code on which is located the clicked button
        // (all cases, whatever contextElement put as parameter, corresponding to a trip).
        // e.g. <div id="block_cruise_trips_0" class="form-group">....</div>

        // take the value of the counter
        const indexTInvestigators = +$('[id^=widgets-counter-tripinvestigators-]', e.target.parentElement.parentElement).val();
        // console.log('value ' + indexTInvestigators);


        // console.log('index investigators ' +indexTInvestigators);


        //get the selector with id corresponding to the trip, eg. '#cruise_trips_1'
        const selectorTripId = '#'+ e.target.parentElement.parentElement.attributes['id']['nodeValue'];
        //also getting the number corresponding to the trip, e.g. '1'
        const tripId = selectorTripId.replace('#block_cruise_trips_', '');

        // console.log($('div#cruise_trips_' + tripId + '_tripinvestigators'));

        //Replace the generic  with adequates labels for the tripinvestigator in the prototype
        //Also, the tripinvestigator prototype that is produced with new trips has already some (wrong) tripinvestigator index by default (instead of '__name__')
        const tmpl = $('div[id=cruise_trips_' + tripId + '_tripinvestigators]').data('prototype').replace(/_tripinvestigators_(__name__|\d+)/g, '_tripinvestigators_'+ indexTInvestigators);
        // const tmpl2 = tmpl.replace(/\\[tripinvestigators\\]\\[(__name__|\d+)\\]/g, '[tripinvestigators][@@@@@@@@@@@'+ indexTInvestigators + ']');
         const tmpl2 = tmpl.replace(/\[tripinvestigators\]\[(__name__|\d+)\]/g, '[tripinvestigators]['+indexTInvestigators+']');

        // console.log('template prototype');
        // console.log(tmpl2);

        const elementTripinvestigator = $(tmpl2);
        // console.log(elementTripinvestigator);

        //append the modified prototype to the section (ad hoc trip section)
        $('div[id=cruise_trips_' + tripId + '_tripinvestigators]').append(elementTripinvestigator);
       // console.log(selectorTripId);
       // console.log(tripId);

        //update the counter of investigators for the trip
        $('input[id^=widgets-counter-tripinvestigators-cruise_trips_' + tripId+ '_tripinvestigators]').val(indexTInvestigators+1);

        deleteTripinvestigators(elementTripinvestigator);
        addClassForAutocomplete(elementTripinvestigator);


    })
}

function deleteTripinvestigators(contextElement){
    $('button#remove-trip-investigator[data-action="delete"]', contextElement).click(function(){
        // console.log('delete !!!!');
        const target = this.dataset.target;
        // console.log('target '+ target);
        // console.log(this.dataset);
        $(target).parent('fieldset').remove();
        // console.log('delete!!!!');
    })
}

function addClassForAutocomplete(contextElement){
    $('input[name$="[firstname]"]', contextElement).addClass("autocomplete-first-name");
    $('input[name$="[surname]"]', contextElement).addClass("autocomplete-surname");
    $(".autocomplete-first-name").easyAutocomplete(optionsFirstNames);
    $(".autocomplete-surname").easyAutocomplete(optionsSurnames);
}




$(document).ready(function () {
    //on document load (e.g. when trip blocks are already there...e.g. on edit mode, or instantiations in the controller (in the development process
   counterTrips = {};


    updateCounterTrips();
    deleteTrip(window.document);
    cloneTrip(window.document);
    AddTripInvestigatorsHandler(window.document);
    deleteTripinvestigators(window.document);
    addClassForAutocomplete(window.document);

});








// function handleCloneButtonsTrips(){
//     $('button#clone-trip[data-action="clone"]').click(function(){
//         const target = this.dataset.target;
//         // const targetPrototype = $(target).data('prototype');
//         // const tmpl =
//         const cont = (target+'_tripinvestigators').replace(/block_/, '');
//         console.log(cont)
//         const tmpl = $(cont).data('prototype');
//         console.log(tmpl);
//         // console.log(target);
//         // console.log(tmpl);
//         // console.log(target);
//         // $(target).clone().appendTo("#cruise_trips");
//     //     const clonedTrip = $(target).clone();
//     //     console.log(clonedTrip);
//     })
// }

/*

function handleCloneButtonsTrips(){
    $('button#clone-trip[data-action="clone"]').click(function(){
        // const index ='67';
        const index = +$('#widgets-counter-trips').val();
        const target = this.dataset.target;
        // console.log('clone' + index)

        const clonedTrip = $(target).clone();

        // console.log(clonedTrip['0'].innerHTML.replace(/_trips_[0-9]/g, '_trips_' + index));
        // console.log(clonedTrip);

       //
       //  NB Somehow unable to modify properties of the object clonedTrip (declared as "let clonedTrip").
       //  Therefore, just extracting the innerHTML code, modify it (also removing the <a> tag linking to trip_edit (as the trip as not been submitted yet),
       //  and appending it to the form
       //

        let clonedTripInnerHtml = clonedTrip['0'].innerHTML.replace(/_trips_\d+/g, '_trips_' + index);
        //
        clonedTripInnerHtml = clonedTripInnerHtml.replace(/\[trips\]\[\d+\]/g, '[trips][' + index + ']');
        clonedTripInnerHtml = "<fieldset class='form-group'>"
            + "<div id='block_cruise_trips_" + index + "' class=form-group'>"
            + clonedTripInnerHtml + "</div></fieldset>";



        // // clonedTripInnerHtml = clonedTripInnerHtml.replace(/<a href="\/trips\/\d+" class="btn btn-primary">Add\/remove investigators<\/a>/, '');
        clonedTripInnerHtml = clonedTripInnerHtml.replace(/<a href="\/trips\/\d+.*\/a>/, '');
        // console.log(clonedTripInnerHtml);
        $(clonedTripInnerHtml).appendTo('div#cruise_trips');
        $('#widgets-counter-trips').val(index+1);
        // console.log(clonedTripInnerHtml);

        handleDeleteButtonsTrips();
        updateCounterTrips();
    })
}
*/

