$('#add-trip').click(function(){
    //Getting the index for the div
    // const index = $('#cruise_trips div.form-group').length;
    const index = +$('#widgets-counter-trips').val(); //unary '+' to convert string to number

    //Getting the prototype (code used to generate the html template)...and adding the index...e.g. position outside the present length
    const tmpl = $('#cruise_trips').data('prototype').replace(/__name__/g, index);
    //Injection of the new code
    var elementTrip = $(tmpl);
    // console.log(element);
    $('#cruise_trips').append(elementTrip);

    //Add 1 to the index (for counter)
    $('#widgets-counter-trips').val(index+1);

    // //get the id of the block, generated by twig...eg. "cruise_trips_0", "cruise_trips_1",.....
    // const idBlockTrip = $(elementTrip[0]['firstElementChild']).attr('id').replace('block_', '');

    //bind the event handler to the 'remove-trip' button that has been created
    deleteTrip(elementTrip);

    //check the events linked ot the button
    // console.log($._data($('[data-action="delete"]')[0], 'events'));

    AddTripInvestigatorsHandler(elementTrip);


})


function deleteTrip(contextElement){
    // 'button#remove-trip[data-action="delete"]'  'button[data-id="'+idBlock+'"][data-action="delete"]'
    $('button.remove-trip[data-action="delete"]', contextElement).click(function(){
        // as we have created in Twig a 'data-target' attribute with the id selector of the block
        const target=this.dataset.target;
        $(target).parent('fieldset').remove();

    })
}


function updateCounterTrips(){
    //counting the number of trip sections (here by counting the input for start date)
    const count = $('input[id$=startdate]').length;
    $('#widgets-counter-trips').val(count);
    // console.log('countTrip ' + count);
    let tripInvestigatorsCount = {};
    //LOOPING (counting the number of counter as the first part of the selector for trip and tripinvestigator is the same
    $('input[id^=widgets-counter-tripinvestigators-][type="hidden"]').each(function(){
        let idCounter = this['id'];
        idCounter = idCounter.replace('widgets-counter-tripinvestigators-', '');
        idCounter= idCounter.replace('_tripinvestigators','');
        //idCounter is a string such as cruise_trips_0, cruise_trips_1,...
        const countTripInvestigators = $('input[id^='+idCounter+'][placeholder="First Name"]').length;

        $('input[id^=widgets-counter-tripinvestigators-'+ idCounter+ '_tripinvestigators]').val(countTripInvestigators);






        // console.log(idCounter);



        tripInvestigatorsCount[idCounter] =  $('input[id^='+idCounter+'][placeholder="First Name"]').length;
        // const counTripinvestigators = $('input[id$=firstname]').length;
        // this.countTripInvestigators = $('input[id$=firstname]').length;
        // console.log(this);
    })

    //Giving the value in the object tripInvestigatorsCount


    // console.log(tripInvestigatorsCount);
}

function updateCounterTripInvestigators(contextElement){

}

function  AddTripInvestigatorsHandler(contextElement){
    //Put the event as argument, as it allow us to get info on the target button
    $( '.add-tripinvestigator',contextElement).click(function(e){
    // $( '[id^=add-tripinvestigator]',contextElement).click(function(e){



        console.log('add tripinvestigator');
        console.log(contextElement);
        // console.log(e.target.parentElement);
        console.log(e.target.parentElement.parentElement);

        //e.target.parentElement.parentElement is actually the block of html code on which is located the clicked button
        // (all cases, whatever contextElement put as parameter, corresponding to a trip).
        // e.g. <div id="block_cruise_trips_0" class="form-group">....</div>

        // take the value of the counter
        const indexTInvestigators = +$('[id^=widgets-counter-tripinvestigators-]', e.target.parentElement.parentElement).val();
        console.log('value ' + indexTInvestigators);

        //get the selector with id corresponding to the trip, eg. '#cruise_trips_1'
        const selectorTripId = '#'+ e.target.parentElement.parentElement.attributes['id']['nodeValue'];
        //also getting the number corresponding to the trip, e.g. '1'
        const tripId = selectorTripId.replace('#block_cruise_trips_', '');

        // console.log($('div#cruise_trips_' + tripId + '_tripinvestigators').data('prototype'));




        const tmpl = $('div[id=cruise_trips_' + tripId + '_tripinvestigators]').data('prototype').replace(/__name__/g, indexTInvestigators);
        const elementTripinvestigator = $(tmpl);
        console.log(elementTripinvestigator);

        // console.log(e.target.parentElement.parentElement.attributes);




        // get the index of the tripinvestigators in the prototype
        $('div[id=cruise_trips_' + tripId + '_tripinvestigators]').append(elementTripinvestigator);
       // console.log(selectorTripId);
       // console.log(tripId);

        //update the counter of investigators for the trip
        $('input[id^=widgets-counter-tripinvestigators-cruise_trips_' + tripId+ '_tripinvestigators]').val(indexTInvestigators+1);






        /*

        // Getting the block number/id for the trip
        var blockTrip = this.attributes['data-block']['nodeValue'];
        blockTrip= blockTrip.replace('cruise_trips_', '');

        // Name of the class to be given to the individual counter
        const classWidgetCounter = 'widgets-counter-tripinvestigators-' + blockTrip;

        // Get the name of the relevant DOM id for the block
        const blockId = 'block_cruise_trips_' + blockTrip;
        // console.log(classWidgetCounter);

        //Get the widget counter (hidden input) that is inside the relevant block and assign it a class
        if (!$('div#' + blockId + ' input[id=widgets-counter-tripinvestigators]').hasClass(classWidgetCounter)){
            $('div#' + blockId + ' input[id=widgets-counter-tripinvestigators]').addClass(classWidgetCounter);
        }

        //Get the value of the counter
        const index = +$('.widgets-counter-tripinvestigators-'+blockTrip).val();
        // id for the division containing the prototype
        const idForPrototype = '#cruise_trips_' + blockTrip + '_tripinvestigators';
        const tmpl = $(idForPrototype).data('prototype').replace(/__name__/g, index);
        var element = $(tmpl);

        $(idForPrototype).append(element);
        $('.widgets-counter-tripinvestigators-'+ blockTrip).val(index + 1);
        // console.log(tmpl);


        updateCounterTripinvestigators(blockId, blockTrip);
        handleDeleteButtonsTripinvestigators(element);


         */

    })
}


$(document).ready(function () {
    //on document load (e.g. when trip blocks are already there...e.g. on edit mode, or instantiations in the controller
    updateCounterTrips();
    deleteTrip(window.document);
    AddTripInvestigatorsHandler(window.document);
    // addIDtoDeleteTripButtonOnLoad(window.document);

});










/*
function  handleAddButtonsTripInvestigators(contextElement){
    $( '.add-tripinvestigator',contextElement).click(function(){
        // Getting the block number/id for the trip
        var blockTrip = this.attributes['data-block']['nodeValue'];
        blockTrip= blockTrip.replace('cruise_trips_', '');

        // Name of the class to be given to the individual counter
        const classWidgetCounter = 'widgets-counter-tripinvestigators-' + blockTrip;

        // Get the name of the relevant DOM id for the block
        const blockId = 'block_cruise_trips_' + blockTrip;
        // console.log(classWidgetCounter);

        //Get the widget counter (hidden input) that is inside the relevant block and assign it a class
        if (!$('div#' + blockId + ' input[id=widgets-counter-tripinvestigators]').hasClass(classWidgetCounter)){
            $('div#' + blockId + ' input[id=widgets-counter-tripinvestigators]').addClass(classWidgetCounter);
        }

        //Get the value of the counter
        const index = +$('.widgets-counter-tripinvestigators-'+blockTrip).val();
        // id for the division containing the prototype
        const idForPrototype = '#cruise_trips_' + blockTrip + '_tripinvestigators';
        const tmpl = $(idForPrototype).data('prototype').replace(/__name__/g, index);
        var element = $(tmpl);

        $(idForPrototype).append(element);
        $('.widgets-counter-tripinvestigators-'+ blockTrip).val(index + 1);
        // console.log(tmpl);


        updateCounterTripinvestigators(blockId, blockTrip);
        handleDeleteButtonsTripinvestigators(element);

    })
}


 */


/*
function handleDeleteButtonsTripinvestigators(contextElement){


    $('button#remove-trip-investigator[data-action="delete"]', contextElement).click(function(){
        // console.log('delete !!!!');
        const target = this.dataset.target;
        // console.log('target '+ target);
        // console.log(this.dataset);
        $(target).parent('fieldset').remove();
        // console.log('delete!!!!');
    })



}
 */

/*
function updateCounterTripinvestigators(blockId, blockTrip) {

    //blockId = 'block_cruise_trips_' + blockTrip; e.g., block_cruise_trips_1
    //blockTrip is the just the digit: e.g., 1
    const count = $('fieldset div[id^='+ blockId + '_tripinvestigators_]').length;
    // console.log(blockId + ' count= ' + count);

    $('.widgets-counter-tripinvestigators-'+ blockTrip).val(count);

}

 */




// function handleCloneButtonsTrips(){
//     $('button#clone-trip[data-action="clone"]').click(function(){
//         const target = this.dataset.target;
//         // const targetPrototype = $(target).data('prototype');
//         // const tmpl =
//         const cont = (target+'_tripinvestigators').replace(/block_/, '');
//         console.log(cont)
//         const tmpl = $(cont).data('prototype');
//         console.log(tmpl);
//         // console.log(target);
//         // console.log(tmpl);
//         // console.log(target);
//         // $(target).clone().appendTo("#cruise_trips");
//     //     const clonedTrip = $(target).clone();
//     //     console.log(clonedTrip);
//     })
// }

/*

function handleCloneButtonsTrips(){
    $('button#clone-trip[data-action="clone"]').click(function(){
        // const index ='67';
        const index = +$('#widgets-counter-trips').val();
        const target = this.dataset.target;
        // console.log('clone' + index)

        const clonedTrip = $(target).clone();

        // console.log(clonedTrip['0'].innerHTML.replace(/_trips_[0-9]/g, '_trips_' + index));
        // console.log(clonedTrip);

       //
       //  NB Somehow unable to modify properties of the object clonedTrip (declared as "let clonedTrip").
       //  Therefore, just extracting the innerHTML code, modify it (also removing the <a> tag linking to trip_edit (as the trip as not been submitted yet),
       //  and appending it to the form
       //

        let clonedTripInnerHtml = clonedTrip['0'].innerHTML.replace(/_trips_\d+/g, '_trips_' + index);
        //
        clonedTripInnerHtml = clonedTripInnerHtml.replace(/\[trips\]\[\d+\]/g, '[trips][' + index + ']');
        clonedTripInnerHtml = "<fieldset class='form-group'>"
            + "<div id='block_cruise_trips_" + index + "' class=form-group'>"
            + clonedTripInnerHtml + "</div></fieldset>";



        // // clonedTripInnerHtml = clonedTripInnerHtml.replace(/<a href="\/trips\/\d+" class="btn btn-primary">Add\/remove investigators<\/a>/, '');
        clonedTripInnerHtml = clonedTripInnerHtml.replace(/<a href="\/trips\/\d+.*\/a>/, '');
        // console.log(clonedTripInnerHtml);
        $(clonedTripInnerHtml).appendTo('div#cruise_trips');
        $('#widgets-counter-trips').val(index+1);
        // console.log(clonedTripInnerHtml);

        handleDeleteButtonsTrips();
        updateCounterTrips();
    })
}
*/

function moveTripDownButton(){

}

/*


function handleDeleteButtonsTrips(){
    $('button#remove-trip[data-action="delete"]').click(function(){
        const target=this.dataset.target;
        //'this' is the button and 'dataset' are the attributes, target "#block_cruise_trips_0
        // remove the whole div
        // console.log(target);

        $(target).parent('fieldset').remove();
        updateCounterTrips();
    })
}

function updateCounterTrips(){
    // const count = $('#cruise_trips div.form-group').length;
    const count = $('input[id$=startdate]').length;
    $('#widgets-counter-trips').val(count);
    console.log('countTrip ' + count);


}


handleDeleteButtonsTrips(window.document);
handleAddButtonsTripInvestigators(window.document);
updateCounterTrips();
console.log()
// updateCounterTripinvestigators(window.document);

 */